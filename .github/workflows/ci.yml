name: Continuous Integration

on:
    push:
        branches:
            - main
        paths-ignore:
            - "**.md"
            - "renovate.json"
            - ".github/ISSUE_TEMPLATE/**"
            - ".github/workflows/release.yml"
    
    pull_request:
        paths-ignore:
            - "**.md"
            - "renovate.json"
            - ".github/ISSUE_TEMPLATE/**"
            - ".github/workflows/release.yml"

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

jobs:
    test-and-analysis:
        name: Test & Analysis
        runs-on: ubuntu-latest
        timeout-minutes: 30
        permissions:
            contents: read
        env:
            SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
            IS_PR: true
        
        steps:
            -   name: Checkout
                uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
                with:
                    fetch-depth: 0
                    show-progress: false

            -   name: Setup .NET
                uses: actions/setup-dotnet@2016bd2012dba4e32de620c46fe006a3ac9f0602 # v5.0.1
                with:
                    global-json-file: global.json
                    cache: true
                    cache-dependency-path: '**/Directory.Packages.props'

            -   name: Restore dependencies
                run: dotnet restore

            -   name: Install SonarCloud scanner
                if: github.actor != 'dependabot[bot]' && github.actor != 'renovate[bot]'
                run: dotnet tool update dotnet-sonarscanner --tool-path ./.sonar/scanner

            -   name: Begin SonarCloud analysis
                if: github.actor != 'dependabot[bot]' && github.actor != 'renovate[bot]'
                run: |
                    ./.sonar/scanner/dotnet-sonarscanner begin \
                      /k:"visus:cuidgen" \
                      /o:"visus" \
                      /d:sonar.token="${SONAR_TOKEN}" \
                      /d:sonar.host.url="https://sonarcloud.io" \
                      /d:sonar.cs.vscoveragexml.reportsPaths="**/TestResults/**/*.xml" \
                      /d:sonar.cs.vstest.reportsPaths="**/TestResults/**/*.trx"              

            -   name: Build
                run: dotnet build -c Release --no-restore

            -   name: Run tests
                run: |
                    dotnet test -c Release --no-build --no-restore -- \
                      --coverage \
                      --coverage-output-format xml \
                      --report-trx              

            -   name: Upload test results
                if: always()
                uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
                with:
                    name: test-results
                    path: "**/TestResults/*.trx"
                    retention-days: 1

            -   name: End SonarCloud analysis
                if: github.actor != 'dependabot[bot]' && github.actor != 'renovate[bot]'
                run: |
                    ./.sonar/scanner/dotnet-sonarscanner end \
                      /d:sonar.token="${SONAR_TOKEN}"              
    
    publish-test-results:
        name: Publish Test Results
        runs-on: ubuntu-latest
        needs: test-and-analysis
        if: always()
        timeout-minutes: 10
        permissions:
            contents: read
            checks: write
            pull-requests: write
        
        steps:
            -   name: Checkout
                uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
                with:
                    fetch-depth: 1
                    show-progress: false

            -   name: Download test results
                uses: actions/download-artifact@634f93cb2916e3fdff6788551b99b062d0335ce0 # v5.0.0
                with:
                    name: test-results
                    path: test-results

            -   name: Publish test results
                uses: dorny/test-reporter@fe45e9537387dac839af0d33ba56eed8e24189e8 # v2.3.0
                with:
                    name: Test Results
                    path: test-results/**/*.trx
                    reporter: dotnet-trx
                    fail-on-error: false
