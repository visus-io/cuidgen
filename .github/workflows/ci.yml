name: Continuous Integration

on:
  push:
    branches:
      - main
    paths-ignore:
      - "**.md"
      - "renovate.json"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/workflows/release.yml"
  
  pull_request:
    paths-ignore:
      - "**.md"
      - "renovate.json"
      - ".github/ISSUE_TEMPLATE/**"
      - ".github/workflows/release.yml"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test-and-analysis:
    name: Test & Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: read
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      IS_PR: true
    
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 0
          show-progress: false

      - name: Setup .NET
        uses: actions/setup-dotnet@baa11fbfe1d6520db94683bd5c7a3818018e4309 # v5.1.0
        with:
          global-json-file: global.json
          cache: true
          cache-dependency-path: '**/Directory.Packages.props'

      - name: Restore dependencies
        run: dotnet restore

      - name: Install SonarCloud scanner
        if: github.actor != 'dependabot[bot]' && github.actor != 'renovate[bot]'
        run: dotnet tool update dotnet-sonarscanner --tool-path ./.sonar/scanner

      - name: Begin SonarCloud analysis
        if: github.actor != 'dependabot[bot]' && github.actor != 'renovate[bot]'
        run: |
          ./.sonar/scanner/dotnet-sonarscanner begin \
            /k:"visus:cuidgen" \
            /o:"visus" \
            /d:sonar.token="${SONAR_TOKEN}" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.cs.vscoveragexml.reportsPaths="**/TestResults/**/*.xml" \
            /d:sonar.cs.vstest.reportsPaths="**/TestResults/**/*.trx"              

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Run tests
        run: |
          dotnet test -c Release --no-build --no-restore -- \
            --coverage \
            --coverage-output-format xml \
            --report-trx              

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: test-results
          path: "**/TestResults/*.trx"
          retention-days: 1

      - name: End SonarCloud analysis
        if: github.actor != 'dependabot[bot]' && github.actor != 'renovate[bot]'
        run: |
          ./.sonar/scanner/dotnet-sonarscanner end \
            /d:sonar.token="${SONAR_TOKEN}"              
  
  publish-test-results:
    name: Publish Test Results
    runs-on: ubuntu-latest
    needs: test-and-analysis
    if: always()
    timeout-minutes: 10
    permissions:
      contents: read
      checks: write
      pull-requests: write
            
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          fetch-depth: 1
          show-progress: false

      - name: Download test results
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # v7.0.0
        with:
          name: test-results
          path: test-results

      - name: Publish test results
        uses: dorny/test-reporter@b082adf0eced0765477756c2a610396589b8c637 # v2.5.0
        with:
          name: Test Results
          path: test-results/**/*.trx
          reporter: dotnet-trx
          fail-on-error: false
